redis 有两种持久化方式

**RDB(Redis DataBase)**

**AOF(Append Only File)**



RDB其实就是把数据以快照的形式保存在磁盘上（二进制文件）

有三种触发方式：save、bgsave、自动化触发，前两种是命令第三种是配置

save：使用 save 触发方式，但是会长时间阻塞

bgsave：一般使用 bgsave 触发方式，就是redis执行fork操作创建子进程来完成rdb持久化工作。

配置触发：在配置文件中配置：“save m n”。表示m秒内数据集存在n次修改时，自动触发 bgsave



rdb 优势劣势

优势

将全量数据持久化在二进制文件中、文件紧凑、适合灾难恢复

fork()子进程来完成rdb，不阻塞主进程

rdb恢复大数据比aof块



RDB 和 AOF 我应该用哪一个？
如果你非常关心你的数据，但仍然可以承受数分钟以内的数据丢失，那么你可以只使用 RDB 持久。

AOF 将 Redis 执行的每一条命令追加到磁盘中，处理巨大的写入会降低 Redis 的性能，不知道你是否可以接受。

数据库备份和灾难恢复：

定时生成 RDB 快照(snapshot)非常便于进行数据库备份， 并且 RDB 恢复数据集的速度也要比 AOF 恢复的速度要快。

Redis 支持同时开启 RDB 和 AOF,系统重启后，Redis 会优先使用 AOF 来恢复数据，这样丢失的数据会最少。









两者比较

1  文件大小   AOF 比 RDB 大

2 恢复速度    RDB 恢复数据比AOF快

3 优先级      如果同时开始两者时优先使用AOF恢复，AOF 文件所保存的数据通常是最完整的。

4 文件类型    AOF是写命令append（追加）生成的日志文件，RDB是某一时间的全量数据的二进制文件（数据快照）

5 数据安全    RDB 可能会丢几分钟的数据，而一般AOF只会丢一秒的，如果是设置的每秒同步的话

6 性能    AOF 会影响redis的QPS，但是开启AOF后性能也是很高的

7  适合的地方  RDB 文件紧凑，适合灾难恢复，也适合数据库备份，AOF比较完整会优先使用，并且有误操作时可以在aof文件中删除那条命令后进行恢复

8 各自的实现方式

 RDB 是 fork()一个子进程去做持久化功能，子进程完成进的RDB文件后会删除旧的，每次fork的成本比较大，所以一般几分钟持久化一次。（有三种方式触发RDB，save、bgsave、自动触发，一般设置自动触发，触发后执行bgsave命令）

AOF 日志文件会每秒（一般设置每秒持久化一次）将写命令和删除命令追加到文件末尾，并且在即将过大的时候会在后台做重写操作(BG REWRITE AOF)，重写不会读取旧的AOF文件，重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合

9 开启方式

```
# aof
appendonly yes
appendfsync everysec
# rdb
 save 60 1000
#这个设置会让 Redis 在满足“ 60 秒内有至少有 1000 个键被改动”这一条件时， 自动保存一次数据集
```

10 一般情况下 aof和rdb会同时开始，相互配合在完成数据的持久化





